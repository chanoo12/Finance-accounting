<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>General Ledger</title>
    <link rel="stylesheet" href="general-ledger.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter&family=Poppins&family=Quicksand&display=swap" rel="stylesheet">
</head>
<body>
    <div class="sidebar">
        <ul>
            <li><a href="home.html">Home</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="accounts.html">Accounts Payable/Receivable</a></li>
            <li><a href="budgeting.html">Budgeting</a></li>
        </ul>
    </div>
    <div class="main-content">
        <h2>General Ledger</h2>
        <div class="form-container">
            <h3>Add New Entry</h3>
            <form id="ledgerForm" autocomplete="off">
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" required>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <input type="text" id="description" required>
                </div>
                <div class="form-group">
                    <label for="debit">Debit:</label>
                    <input type="number" id="debit" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="credit">Credit:</label>
                    <input type="number" id="credit" step="0.01" min="0">
                </div>
                <button type="submit" class="btn-primary">Add Entry</button>
            </form>
        </div>

        <div class="table-container">
            <h3>Ledger Entries</h3>
            <table id="ledgerTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Entries will appear here -->
                </tbody>
            </table>
        </div>

        <!-- Edit Modal -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <h3>Edit Entry</h3>
                <form id="editForm">
                    <input type="hidden" id="editId">
                    <div class="form-group">
                        <label for="editDate">Date:</label>
                        <input type="date" id="editDate" required>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">Description:</label>
                        <input type="text" id="editDescription" required>
                    </div>
                    <div class="form-group">
                        <label for="editDebit">Debit:</label>
                        <input type="number" id="editDebit" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="editCredit">Credit:</label>
                        <input type="number" id="editCredit" step="0.01" min="0">
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn-primary">Save Changes</button>
                        <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Fetch all ledger entries
        async function fetchLedgerEntries() {
            try {
                const response = await fetch('http://localhost:3000/api/ledger');
                const entries = await response.json();
                const tbody = document.querySelector('#ledgerTable tbody');
                tbody.innerHTML = '';
                entries.forEach(entry => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                        <td>${entry.description}</td>
                        <td>${entry.debit !== null && entry.debit !== undefined ? '$' + Number(entry.debit).toFixed(2) : ''}</td>
                        <td>${entry.credit !== null && entry.credit !== undefined ? '$' + Number(entry.credit).toFixed(2) : ''}</td>
                        <td>${entry.balance !== null && entry.balance !== undefined ? '$' + Number(entry.balance).toFixed(2) : ''}</td>
                        <td>
                            <button class="btn-edit" onclick="openEditModal('${entry.entry_id}')">Edit</button>
                            <button class="btn-delete" onclick="deleteEntry('${entry.entry_id}')">Delete</button>
                            <button class="btn-view" onclick="viewEntry('${entry.entry_id}')">View</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching entries:', error);
                alert('Failed to load ledger entries');
            }
        }

           // View entry
           async function viewEntry(entryId) {
               try {
                   const response = await fetch(`/api/ledger/${entryId}`);
                   const entry = await response.json();
                   alert(`Date: ${entry.date}\nDescription: ${entry.description}\nDebit: ${entry.debit}\nCredit: ${entry.credit}\nBalance: ${entry.balance}`);
               } catch (error) {
                   alert('Failed to view entry');
               }
           }

        // Add new entry
        document.getElementById('ledgerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                debit: document.getElementById('debit').value ? parseFloat(document.getElementById('debit').value) : null,
                credit: document.getElementById('credit').value ? parseFloat(document.getElementById('credit').value) : null,
                balance: calculateBalance(
                    document.getElementById('debit').value ? parseFloat(document.getElementById('debit').value) : 0,
                    document.getElementById('credit').value ? parseFloat(document.getElementById('credit').value) : 0
                )
            };

            try {
                const response = await fetch('http://localhost:3000/api/ledger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    e.target.reset();
                    fetchLedgerEntries();
                } else {
                    throw new Error('Failed to add entry');
                }
            } catch (error) {
                console.error('Error adding entry:', error);
                alert('Failed to add entry');
            }
        });

        // Edit entry
        async function openEditModal(entryId) {
            try {
                const response = await fetch(`http://localhost:3000/api/ledger/${entryId}`);
                const entry = await response.json();
                
                document.getElementById('editId').value = entry.entry_id;
                document.getElementById('editDate').value = entry.date.split('T')[0];
                document.getElementById('editDescription').value = entry.description;
                document.getElementById('editDebit').value = entry.debit || '';
                document.getElementById('editCredit').value = entry.credit || '';
                
                document.getElementById('editModal').style.display = 'block';
            } catch (error) {
                console.error('Error fetching entry:', error);
                alert('Failed to load entry details');
            }
        }

        // Update entry
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const entryId = document.getElementById('editId').value;
            const formData = {
                date: document.getElementById('editDate').value,
                description: document.getElementById('editDescription').value,
                debit: document.getElementById('editDebit').value ? parseFloat(document.getElementById('editDebit').value) : null,
                credit: document.getElementById('editCredit').value ? parseFloat(document.getElementById('editCredit').value) : null,
                balance: calculateBalance(
                    document.getElementById('editDebit').value ? parseFloat(document.getElementById('editDebit').value) : 0,
                    document.getElementById('editCredit').value ? parseFloat(document.getElementById('editCredit').value) : 0
                )
            };

            try {
                const response = await fetch(`http://localhost:3000/api/ledger/${entryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    closeEditModal();
                    fetchLedgerEntries();
                } else {
                    throw new Error('Failed to update entry');
                }
            } catch (error) {
                console.error('Error updating entry:', error);
                alert('Failed to update entry');
            }
        });

        // Delete entry
        async function deleteEntry(entryId) {
            if (confirm('Are you sure you want to delete this entry?')) {
                try {
                    const response = await fetch(`http://localhost:3000/api/ledger/${entryId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        fetchLedgerEntries();
                    } else {
                        throw new Error('Failed to delete entry');
                    }
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    alert('Failed to delete entry');
                }
            }
        }

        // Helper functions
        function calculateBalance(debit, credit) {
            return debit - credit;
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', fetchLedgerEntries);
    // No need to load crud.js here; all logic is self-contained for ledger
    </script>
</body>
</html>